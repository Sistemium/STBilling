<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="stb-org-dashboard" label="Биллинг по организации">
	
    <view-schema>
        <form name="ST">
			
            <parameter name="name">
                <init with="username"/>
            </parameter>
			
            <parameter name="org">
                <init with="role">org</init>
            </parameter>
			
			<form name="Billing" concept="stb-org">
				
				<join name="sysuser" field="org" property="name"/>
				
				<field name="id"/>
				
				<form name="stb-period" is-set="true" page-size="10">
					
					<order-by name="dateB" dir="desc"/>
					
					<field name="id"/>
					
					<field name="dateB"/>
					<field name="dateE"/>
					
				</form>
				
			</form>
			
			<form name="stb-period-detailed" concept="stb-period">
				
				<parameter name="period-to-detail-id" type="int" property="id" modifiable="true"/>
				<parameter name="period-to-detail-org" type="int" modifiable="true"/>
				
				<field name="dateB"/>
				<field name="dateE"/>
				
				<form name="stb-tariff" is-set="true">
					
					<field name="price"/>
					
					<join name="stb-period-detailed" field="period-to-detail-org" property="org"/>
					
					<form name="stb-service" concept="stb-service">
						
						<field name="name"/>
						
						<form name="stb-period-detailed-accural" concept="stb-accrual">
							
							<join name="stb-period-detailed" field="dateB"/>
							<join name="stb-period-detailed" field="dateE"/>
							
							<field name="volume" aggregate="sum"/>
							<field name="cost" type="decimal" sql-compute="null" label="Стоимость">
								<xpath-compute>
									ancestor::xi:data [@name='stb-tariff'] /xi:datum [@name='price']
									* preceding-sibling::xi:datum [@name='volume']
								</xpath-compute>
							</field>
							
						</form>
						
					</form>
					
				</form>
				
			</form>
			
        </form>
    </view-schema>
	
    <workflow>
		
        <step name="index-step" label="Выбор периода">
			
            <display>
				
				<grid form="stb-period">
					<option reuse="period-detail-button"/>
				</grid>
				
            </display>
            
        </step>
		
        <step name="detail-step" label="Детали периода" hidden="true">
			
            <options>
				<option reuse="to-index"/>
            </options>
			
            <display>
				
				<print form="stb-period-detailed" field="*"/>
				
				<grid form="stb-period-detailed-accural" label="Начисления">
					<columns>
						<column form="stb-service" field="name"/>
						<column form="stb-tariff" field="price"/>
						<column field="volume"/>
						<column field="cost"/>
					</columns>
				</grid>
				
            </display>
			
        </step>
		
		<reusables>
			
            <option name="period-detail-button" label="...">
                <command name="period-to-detail-id" xpath-compute="xi:datum[@name='id']"/>
                <command name="period-to-detail-org" xpath-compute="ancestor::xi:data[@name='Billing']/xi:datum[@name='id']"/>
				<command name="stb-org-dashboard">detail-step</command>
            </option>
			
            <option name="to-index" label="К выбору периода">
				<command name="stb-org-dashboard">index-step</command>
            </option>
			
		</reusables>
		
    </workflow>
	
</view-definition>